rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Funciones de ayuda ---
    function isSignedIn() { return request.auth != null; }
    function isAdmin() { 
      return isSignedIn() && (
        exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid)) ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      ); 
    }
    function isOwner(userId) { return isSignedIn() && request.auth.uid == userId; }

    // --- Secciones de la Home y Categor√≠as ---
    match /home_sections/{sectionId} { allow read: if true; allow write: if isAdmin(); }
    match /categories/{categoryId} { allow read: if true; allow write: if isAdmin(); }

    // --- Beneficios ---
    match /benefits/{benefitId} {
      allow read: if true;
      allow write: if isAdmin() || (isSignedIn() && request.resource.data.supplierId == request.auth.uid) || (isSignedIn() && resource.data.supplierId == request.auth.uid);
    }

    // --- CANJES Y USUARIOS ---
    match /users/{userId} { allow read: if true; allow write: if isOwner(userId) || isAdmin(); }
    match /users/{userId}/redeemed_benefits/{document=**} { allow read, write: if isOwner(userId) || isAdmin(); }
    match /benefitRedemptions/{document=**} { allow read, create: if isSignedIn(); allow update, delete: if isAdmin(); }
    match /roles_admin/{adminId} { allow read, write: if isAdmin(); }
    
    // --- NUEVO: PERFIL DEL CLUBER (Disponibilidad) ---
    // Ahora el proveedor puede editar sus propios horarios
    match /roles_supplier/{supplierId} { 
      allow read: if true; 
      allow write: if isAdmin() || isOwner(supplierId); 
    }

    // --- NUEVO: TURNOS Y SERVICIOS ---
    match /appointments/{appointmentId} {
      allow read, write: if isSignedIn(); // Permite a usuarios y locales gestionar turnos
    }
    match /services/{serviceId} {
      allow read: if true;
      allow write: if isSignedIn(); // Permite a los locales crear servicios
    }
  }
}